package org.apache.streams.twitter.processor;

import com.google.common.collect.Maps;
import org.apache.streams.exceptions.ActivitySerializerException;
import org.apache.streams.pojo.json.Activity;
import org.junit.Assert;
import org.junit.Test;

import java.io.IOException;
import java.util.Map;

public class FetchAndReplaceTwitterProcessorTest {
    private final String json = "{\"retweeted\":false,\"in_reply_to_screen_name\":null,\"possibly_sensitive\":false,\"truncated\":false,\"lang\":\"en\",\"in_reply_to_status_id_str\":null,\"id\":623892436108967936,\"extended_entities\":{\"media\":[{\"sizes\":{\"small\":{\"w\":340,\"resize\":\"fit\",\"h\":170},\"thumb\":{\"w\":150,\"resize\":\"crop\",\"h\":150},\"medium\":{\"w\":600,\"resize\":\"fit\",\"h\":300},\"large\":{\"w\":1024,\"resize\":\"fit\",\"h\":512}},\"source_user_id\":45800443,\"media_url\":\"http://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"display_url\":\"pic.twitter.com/deojKX3HHg\",\"type\":\"photo\",\"url\":\"http://t.co/deojKX3HHg\",\"id\":619434495758864384,\"media_url_https\":\"https://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"expanded_url\":\"http://twitter.com/IntelIndia/status/619434495880499200/photo/1\",\"source_user_id_str\":\"45800443\",\"indices\":[118,140],\"source_status_id_str\":\"619434495880499200\",\"source_status_id\":619434495880499200,\"id_str\":\"619434495758864384\"}]},\"in_reply_to_user_id_str\":null,\"in_reply_to_status_id\":null,\"created_at\":\"Wed Jul 22 16:28:42 +0000 2015\",\"favorite_count\":0,\"place\":null,\"coordinates\":null,\"possibly_sensitive_appealable\":false,\"text\":\"RT @IntelITCenter: Here\\u2019s how you can be #WorkingBetter with Intel wireless docking technology http://t.co/zCUEifJDi1 http://t.co/deojKX3HHg\",\"contributors\":null,\"retweeted_status\":{\"retweeted\":false,\"in_reply_to_screen_name\":null,\"possibly_sensitive\":false,\"truncated\":false,\"lang\":\"en\",\"in_reply_to_status_id_str\":null,\"id\":619438491269607426,\"scopes\":{\"followers\":false},\"extended_entities\":{\"media\":[{\"sizes\":{\"small\":{\"w\":340,\"resize\":\"fit\",\"h\":170},\"thumb\":{\"w\":150,\"resize\":\"crop\",\"h\":150},\"medium\":{\"w\":600,\"resize\":\"fit\",\"h\":300},\"large\":{\"w\":1024,\"resize\":\"fit\",\"h\":512}},\"source_user_id\":45800443,\"media_url\":\"http://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"display_url\":\"pic.twitter.com/deojKX3HHg\",\"type\":\"photo\",\"url\":\"http://t.co/deojKX3HHg\",\"id\":619434495758864384,\"media_url_https\":\"https://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"expanded_url\":\"http://twitter.com/IntelIndia/status/619434495880499200/photo/1\",\"source_user_id_str\":\"45800443\",\"indices\":[99,121],\"source_status_id_str\":\"619434495880499200\",\"source_status_id\":619434495880499200,\"id_str\":\"619434495758864384\"}]},\"in_reply_to_user_id_str\":null,\"in_reply_to_status_id\":null,\"created_at\":\"Fri Jul 10 09:30:19 +0000 2015\",\"favorite_count\":51,\"place\":null,\"coordinates\":null,\"possibly_sensitive_appealable\":false,\"text\":\"Here\\u2019s how you can be #WorkingBetter with Intel wireless docking technology http://t.co/zCUEifJDi1 http://t.co/deojKX3HHg\",\"contributors\":null,\"geo\":null,\"entities\":{\"symbols\":[],\"urls\":[{\"expanded_url\":\"http://intel.ly/1CtACsO\",\"indices\":[76,98],\"display_url\":\"intel.ly/1CtACsO\",\"url\":\"http://t.co/zCUEifJDi1\"}],\"hashtags\":[{\"text\":\"WorkingBetter\",\"indices\":[22,36]}],\"media\":[{\"sizes\":{\"small\":{\"w\":340,\"resize\":\"fit\",\"h\":170},\"thumb\":{\"w\":150,\"resize\":\"crop\",\"h\":150},\"medium\":{\"w\":600,\"resize\":\"fit\",\"h\":300},\"large\":{\"w\":1024,\"resize\":\"fit\",\"h\":512}},\"source_user_id\":45800443,\"media_url\":\"http://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"display_url\":\"pic.twitter.com/deojKX3HHg\",\"type\":\"photo\",\"url\":\"http://t.co/deojKX3HHg\",\"id\":619434495758864384,\"media_url_https\":\"https://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"expanded_url\":\"http://twitter.com/IntelIndia/status/619434495880499200/photo/1\",\"source_user_id_str\":\"45800443\",\"indices\":[99,121],\"source_status_id_str\":\"619434495880499200\",\"source_status_id\":619434495880499200,\"id_str\":\"619434495758864384\"}],\"user_mentions\":[]},\"is_quote_status\":false,\"source\":\"<a href=\\\"https://ads.twitter.com\\\" rel=\\\"nofollow\\\">Twitter Ads<\\/a>\",\"favorited\":false,\"in_reply_to_user_id\":null,\"retweet_count\":32,\"id_str\":\"619438491269607426\",\"user\":{\"location\":\"Santa Clara, CA\",\"default_profile\":false,\"profile_background_tile\":false,\"statuses_count\":17795,\"lang\":\"en\",\"profile_link_color\":\"0071C5\",\"profile_banner_url\":\"https://pbs.twimg.com/profile_banners/26775859/1430853039\",\"id\":26775859,\"following\":false,\"protected\":false,\"favourites_count\":3211,\"profile_text_color\":\"444444\",\"description\":\"IT best practices, strategies & tools from IT experts at Intel. More @ http://t.co/KExSLGY2zX and join our community http://t.co/IVvHTviD6t #ITCenter\",\"verified\":true,\"contributors_enabled\":false,\"profile_sidebar_border_color\":\"FFFFFF\",\"name\":\"Intel IT Center\",\"profile_background_color\":\"EBEEF2\",\"created_at\":\"Thu Mar 26 15:40:00 +0000 2009\",\"is_translation_enabled\":false,\"default_profile_image\":false,\"followers_count\":183310,\"has_extended_profile\":false,\"profile_image_url_https\":\"https://pbs.twimg.com/profile_images/613132320527101953/dWL30ynv_normal.png\",\"geo_enabled\":false,\"profile_background_image_url\":\"http://pbs.twimg.com/profile_background_images/378800000176660567/fWwYKrCJ.png\",\"profile_background_image_url_https\":\"https://pbs.twimg.com/profile_background_images/378800000176660567/fWwYKrCJ.png\",\"follow_request_sent\":false,\"entities\":{\"description\":{\"urls\":[{\"expanded_url\":\"http://www.intel.com/ITCenter\",\"indices\":[71,93],\"display_url\":\"intel.com/ITCenter\",\"url\":\"http://t.co/KExSLGY2zX\"},{\"expanded_url\":\"http://www.intel.com/ITPN\",\"indices\":[117,139],\"display_url\":\"intel.com/ITPN\",\"url\":\"http://t.co/IVvHTviD6t\"}]},\"url\":{\"urls\":[{\"expanded_url\":\"http://www.intel.com/ITCenter\",\"indices\":[0,22],\"display_url\":\"intel.com/ITCenter\",\"url\":\"http://t.co/WJgNBYpVzW\"}]}},\"url\":\"http://t.co/WJgNBYpVzW\",\"utc_offset\":-25200,\"time_zone\":\"Pacific Time (US & Canada)\",\"notifications\":false,\"profile_use_background_image\":true,\"friends_count\":1811,\"profile_sidebar_fill_color\":\"86C6E3\",\"screen_name\":\"IntelITCenter\",\"id_str\":\"26775859\",\"profile_image_url\":\"http://pbs.twimg.com/profile_images/613132320527101953/dWL30ynv_normal.png\",\"listed_count\":726,\"is_translator\":false}},\"geo\":null,\"entities\":{\"symbols\":[],\"urls\":[{\"expanded_url\":\"http://intel.ly/1CtACsO\",\"indices\":[95,117],\"display_url\":\"intel.ly/1CtACsO\",\"url\":\"http://t.co/zCUEifJDi1\"}],\"hashtags\":[{\"text\":\"WorkingBetter\",\"indices\":[41,55]}],\"media\":[{\"sizes\":{\"small\":{\"w\":340,\"resize\":\"fit\",\"h\":170},\"thumb\":{\"w\":150,\"resize\":\"crop\",\"h\":150},\"medium\":{\"w\":600,\"resize\":\"fit\",\"h\":300},\"large\":{\"w\":1024,\"resize\":\"fit\",\"h\":512}},\"source_user_id\":45800443,\"media_url\":\"http://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"display_url\":\"pic.twitter.com/deojKX3HHg\",\"type\":\"photo\",\"url\":\"http://t.co/deojKX3HHg\",\"id\":619434495758864384,\"media_url_https\":\"https://pbs.twimg.com/media/CJisZFlUkAAO5pE.jpg\",\"expanded_url\":\"http://twitter.com/IntelIndia/status/619434495880499200/photo/1\",\"source_user_id_str\":\"45800443\",\"indices\":[118,140],\"source_status_id_str\":\"619434495880499200\",\"source_status_id\":619434495880499200,\"id_str\":\"619434495758864384\"}],\"user_mentions\":[{\"id\":26775859,\"name\":\"Intel IT Center\",\"indices\":[3,17],\"screen_name\":\"IntelITCenter\",\"id_str\":\"26775859\"}]},\"is_quote_status\":false,\"source\":\"<a href=\\\"http://twitter.com\\\" rel=\\\"nofollow\\\">Twitter Web Client<\\/a>\",\"favorited\":false,\"in_reply_to_user_id\":null,\"retweet_count\":32,\"id_str\":\"623892436108967936\",\"user\":{\"location\":\"India\",\"default_profile\":false,\"profile_background_tile\":false,\"statuses_count\":3534,\"lang\":\"en\",\"profile_link_color\":\"4A913C\",\"profile_banner_url\":\"https://pbs.twimg.com/profile_banners/2811504578/1436929991\",\"id\":2811504578,\"following\":false,\"protected\":false,\"favourites_count\":13,\"profile_text_color\":\"000000\",\"description\":\"Founder and CEO at Computer Security_Tracing_Hacking | Blogger | Linux (Ubuntu) Lover | Internet and Computer Addicted\",\"verified\":false,\"contributors_enabled\":false,\"profile_sidebar_border_color\":\"000000\",\"name\":\"Dipanjan Dey\",\"profile_background_color\":\"000000\",\"created_at\":\"Mon Sep 15 15:27:48 +0000 2014\",\"is_translation_enabled\":false,\"default_profile_image\":false,\"followers_count\":318,\"has_extended_profile\":true,\"profile_image_url_https\":\"https://pbs.twimg.com/profile_images/621155341812641792/OMMdCNAY_normal.jpg\",\"geo_enabled\":false,\"profile_background_image_url\":\"http://abs.twimg.com/images/themes/theme1/bg.png\",\"profile_background_image_url_https\":\"https://abs.twimg.com/images/themes/theme1/bg.png\",\"follow_request_sent\":false,\"entities\":{\"description\":{\"urls\":[]},\"url\":{\"urls\":[{\"expanded_url\":\"http://dipanjandey.blogspot.in/\",\"indices\":[0,22],\"display_url\":\"dipanjandey.blogspot.in\",\"url\":\"http://t.co/qyE9MdxMtM\"}]}},\"url\":\"http://t.co/qyE9MdxMtM\",\"utc_offset\":-25200,\"time_zone\":\"Pacific Time (US & Canada)\",\"notifications\":false,\"profile_use_background_image\":false,\"friends_count\":592,\"profile_sidebar_fill_color\":\"000000\",\"screen_name\":\"IAmDipanjanDey\",\"id_str\":\"2811504578\",\"profile_image_url\":\"http://pbs.twimg.com/profile_images/621155341812641792/OMMdCNAY_normal.jpg\",\"listed_count\":66,\"is_translator\":false}}";
    private Activity activity = null;

    @Test
    public void testLocationReplacement() throws IOException, ActivitySerializerException {
        Map<String, Object> extensions = Maps.newHashMap();
        Map<String, Object> location = Maps.newHashMap();

        extensions.put("location", location);
        location.put("country", "us");

        FetchAndReplaceTwitterProcessor fetchAndReplaceTwitterProcessor = new FetchAndReplaceTwitterProcessor();
        fetchAndReplaceTwitterProcessor.prepare(null);

        activity = new Activity();
        activity.setAdditionalProperty("extensions", extensions);

        fetchAndReplaceTwitterProcessor.replace(activity, json);

        String country = getCountry(activity);
        Assert.assertEquals("us", country);
    }

    private String getCountry(Activity activity) {
        String country = "";

        Map<String, Object> extensions = (Map<String, Object>)activity.getAdditionalProperties().get("extensions");
        Map<String, Object> location = (Map<String, Object>)extensions.get("location");

        if(location != null) {
            country = (String)location.get("country");
        }

        return country;
    }
}